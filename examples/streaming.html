<html>
    <head>
        <title>Sieve example:  Streaming</title>
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    </head>
    <body>
        <div class="jumbotron">
            <div class="container">
                <h1>Sieve example: Streaming</h1>
                <p>Watch results roll in via WebSocket.</p>

                <form class="form-inline" role="form">
                    <div class="form-group">
                        <input type="text" id="username" class="form-control" placeholder="GitHub Username">
                        <button id="go" class="btn btn-primary">Go!</button>
                    </div>
                </form>
                <div class="alert alert-danger alert-dismissable" style="display: none" id="error"></div>
            </div>
        </div>
        <div id="graphs" class="container"></div>
        <div class="container">
            <div class="alert alert-success alert-dismissable" style="display: none" id="display"></div>
        </div>
    </body>
    <script>

(function($){
$(document).ready(function(){

var server = 'ws://sieve.alexose.com:8082/'
  , ws = new WebSocket(server);

ws.onmessage = function(event){
  display(JSON.parse(event.data));
};

$('#go').click(function(e){

    e.preventDefault();

    // Read username from input box
    var user = $('#username').val();

    // Basic validation
    if (!user || !user.length){
        error('Please type a username.');
    }

    // Construct a Sieve request
    var request = {
        url : "https://api.github.com/users/{{user}}/repos",
        data : {
            user : user
        },
        selector : {
            name : ".name"
        },
        then : {
            url : "https://api.github.com/repos/{{user}}/{{name}}/commits",
            selector : {
                message : ":has(.author .login:val(\"{{user}}\")) :root.commit .message"
            }
        }
    }

    var json = JSON.stringify(request);
    // Send request to Sieve using websocket
    ws.send(json);
});

// Pretty-print request
function display(json){
    var str = JSON.stringify(json, null, '\t');

    $('#display')
        .prepend(
            $('<pre />')
                .html(str)
        )
        .fadeIn();
}

// Bootstrappy error handler
var timeout;
function error(message){

    var el = $('#error');

    el
        .text(message)
        .fadeIn();

    if (timeout){
        clearTimeout(timeout);
    }

    var timeout = setTimeout(function(){
        el.fadeOut();
    }, 6000);
}

});
})(jQuery);


    </script>
</html>
